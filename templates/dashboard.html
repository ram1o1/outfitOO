<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - {{ app_name }}</title>
    <style>
        /* Reuse some styles from landing page for consistency */
        body { font-family: system-ui, sans-serif; margin: 0; background-color: #f4f7fa; color: #333; }
        .navbar { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .navbar .logo { font-weight: 800; font-size: 1.5em; color: #333; text-decoration: none;}
        .nav-links a { margin-left: 20px; text-decoration: none; color: #555; font-weight: 500; }
        .nav-links a:hover { color: #4285F4; }
        
        .container { max-width: 900px; margin: 40px auto; padding: 20px; }
        
        /* Upload Section Styles */
        .upload-container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
        .headline { text-align: center; margin-bottom: 30px; font-weight: 300; font-size: 1.8em; }
        
        .side-by-side { display: flex; gap: 30px; margin-bottom: 30px; }
        .upload-box { flex: 1; border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; position: relative; background: #fafafa; transition: border-color 0.3s; }
        .upload-box:hover { border-color: #4285F4; }
        .upload-box input[type="file"] { position: absolute; width: 100%; height: 100%; top: 0; left: 0; opacity: 0; cursor: pointer; }
        .preview-img { max-width: 100%; max-height: 200px; margin-top: 15px; display: none; border-radius: 4px;}
        
        .generate-btn { width: 100%; padding: 15px; background-color: #4285F4; color: white; border: none; border-radius: 8px; font-size: 1.2em; font-weight: 600; cursor: pointer; transition: background 0.3s; }
        .generate-btn:hover { background-color: #357ae8; }
        .generate-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Result Section */
        #result-section { margin-top: 40px; text-align: center; display: none; animation: fadeIn 0.5s; }
        .generated-img-container { margin: 20px auto; max-width: 500px; }
        .generated-img { width: 100%; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .download-link { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #333; color: white; text-decoration: none; border-radius: 6px; }
        
        .loading-spinner { border: 4px solid #f3f3f3; border-top: 4px solid #4285F4; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 20px auto; display: none;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/dashboard" class="logo">{{ app_name }}</a>
        <div class="nav-links">
            <span>Welcome, {{ user_email }}</span>
            <a href="/dashboard">Create</a>
            <a href="/history">History</a>
            <a href="/auth/logout" style="color: #d93025;">Logout</a>
        </div>
    </nav>

    <div class="container">
        <div class="upload-container">
            <h1 class="headline">Create Your New Look</h1>
            
            <form id="generation-form">
                <div class="side-by-side">
                    <div class="upload-box">
                        <p>Drop <strong>Your Photo</strong> here or click to upload</p>
                        <input type="file" id="userPhotoInput" name="user_photo" accept="image/*" required>
                        <img id="userPreview" class="preview-img" alt="User Preview">
                    </div>
                    
                    <div class="upload-box">
                        <p>Drop <strong>Outfit Photo</strong> here or click to upload</p>
                        <input type="file" id="outfitPhotoInput" name="outfit_photo" accept="image/*" required>
                        <img id="outfitPreview" class="preview-img" alt="Outfit Preview">
                    </div>
                </div>
                
                <button type="submit" class="generate-btn" id="generateBtn">Generate Outfit</button>
                <div class="loading-spinner" id="loader"></div>
            </form>
        </div>

        <div id="result-section">
            <h2>Result</h2>
            <div class="generated-img-container">
                <img id="generatedImage" class="generated-img" src="" alt="Generated Outfit">
            </div>
             <a href="" id="downloadLink" class="download-link" download="my-new-outfit.jpg">Download Image</a>
        </div>
    </div>

    <script>
        // --- Frontend Logic ---
        const form = document.getElementById('generation-form');
        const generateBtn = document.getElementById('generateBtn');
        const loader = document.getElementById('loader');
        const resultSection = document.getElementById('result-section');
        const generatedImage = document.getElementById('generatedImage');
        const downloadLink = document.getElementById('downloadLink');

        // Helper for image previews
        function setupPreview(inputId, imgId) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.getElementById(imgId);
                        img.src = e.target.result;
                        img.style.display = 'block';
                        img.previousElementSibling.style.display = 'none'; // Hide placeholder text
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        setupPreview('userPhotoInput', 'userPreview');
        setupPreview('outfitPhotoInput', 'outfitPreview');

        // Handle Form Submission via AJAX
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            // UI states
            generateBtn.disabled = true;
            generateBtn.textContent = "Processing...";
            loader.style.display = 'block';
            resultSection.style.display = 'none';

            const formData = new FormData();
            formData.append('user_photo', document.getElementById('userPhotoInput').files[0]);
            formData.append('outfit_photo', document.getElementById('outfitPhotoInput').files[0]);

            try {
                // Call the new backend API endpoint
                const response = await fetch('/api/generate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Show result
                    generatedImage.src = data.image_url;
                    downloadLink.href = data.image_url;
                    resultSection.style.display = 'block';
                } else {
                    alert('Error generating outfit: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An unexpected error occurred.');
            } finally {
                // Reset UI states
                generateBtn.disabled = false;
                generateBtn.textContent = "Generate Outfit";
                loader.style.display = 'none';
            }
        });
    </script>
</body>
</html>